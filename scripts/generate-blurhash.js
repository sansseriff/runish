import { encode } from 'blurhash';
import { writeFileSync } from 'fs';
import { createCanvas, loadImage } from 'canvas';

/**
 * Generate blurhash string from an image file
 * @param {string} imagePath - Path to the image file
 * @param {number} componentX - X component count (default: 4)
 * @param {number} componentY - Y component count (default: 4)
 * @returns {Promise<string>} - Blurhash string
 */
async function generateBlurhash(imagePath, componentX = 9, componentY = 9) {
	try {
		const image = await loadImage(imagePath);
		const canvas = createCanvas(image.width, image.height);
		const ctx = canvas.getContext('2d');
		ctx.drawImage(image, 0, 0);

		const imageData = ctx.getImageData(0, 0, image.width, image.height);
		const hash = encode(imageData.data, imageData.width, imageData.height, componentX, componentY);
		return hash;
	} catch (error) {
		console.error(`Error generating blurhash for ${imagePath}:`, error);
		return null;
	}
}

/**
 * Generate blurhash strings for all portfolio images
 */
async function main() {
	const images = [
		{ path: './static/images/traversable_wormholes.jpeg', key: 'traversable_wormholes' },
		{ path: './static/images/feathered_peacoq.png', key: 'feathered_peacoq' }
	];

	const results = {};

	for (const image of images) {
		console.log(`Generating blurhash for ${image.path}...`);
		const hash = await generateBlurhash(image.path);
		if (hash) {
			results[image.key] = hash;
			console.log(`✓ ${image.key}: ${hash}`);
		} else {
			console.error(`✗ Failed to generate blurhash for ${image.key}`);
		}
	}

	// Output as JSON that can be imported
	const output = `// This file is auto-generated by scripts/generate-blurhash.js
// Run: bun run scripts/generate-blurhash.js

export const blurhashes = ${JSON.stringify(results, null, '\t')} as const;
`;

	console.log('\n--- Generated blurhashes ---');
	console.log(JSON.stringify(results, null, 2));
	console.log('\n--- Output file content ---');
	console.log(output);

	// Write to file
	writeFileSync('./src/lib/blurhashes.ts', output);
	console.log('\n✓ Written to src/lib/blurhashes.ts');
}

main().catch(console.error);

